<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEXO | Rider Intelligence Network</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { neonPurple: '#9D00FF', neonBlue: '#00D1FF' }, animation: { 'bounce-slow': 'bounce 2s infinite' } } }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Syncopate:wght@400;700&family=Rajdhani:wght@300;500;700&display=swap');
        body { font-family: 'Rajdhani', sans-serif; overflow: hidden; touch-action: manipulation; }
        #map { height: 100vh; width: 100vw; position: absolute; top: 0; left: 0; z-index: 1; }
        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(0, 0, 0, 0.1); }
        .dark .glass { background: rgba(15, 15, 15, 0.85); border: 1px solid rgba(157, 0, 255, 0.3); }
        .ui-element { z-index: 1000; position: relative; }
        /* Ocultar el panel por defecto de la librer√≠a de rutas para usar el nuestro */
        .leaflet-routing-container { display: none !important; }
        .modal-active { animation: slideUp 0.35s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="bg-[#050505] text-gray-100">

    <div id="login-screen" class="fixed inset-0 z-[5000] bg-black flex flex-col justify-center items-center p-6 text-center">
        <h1 class="text-6xl font-bold font-[Syncopate] mb-8 bg-clip-text text-transparent bg-gradient-to-r from-neonBlue to-neonPurple text-white">NEXO</h1>
        <div class="w-full max-w-xs space-y-4">
            <input id="userName" type="text" placeholder="ID OPERADOR" class="w-full bg-zinc-900 border border-zinc-700 p-4 rounded-2xl outline-none text-center font-mono focus:border-neonPurple text-white">
            <button onclick="app.registerUser()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 py-4 rounded-2xl font-black text-white shadow-lg">ENTRAR</button>
        </div>
    </div>

    <div id="main-ui" class="hidden opacity-0 transition-opacity duration-700">
        <header class="fixed top-4 left-4 right-4 ui-element">
            <div class="glass rounded-2xl p-3 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <img id="userAvatar" class="w-10 h-10 rounded-full border-2 border-purple-500 shadow-md">
                    <div>
                        <h2 id="userNameDisplay" class="font-bold text-xs uppercase leading-none">...</h2>
                        <span id="pointsDisplay" class="text-neonBlue font-mono text-[10px] font-bold">0 NP</span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="app.toggleRouteMode()" id="route-btn" class="w-10 h-10 rounded-full bg-zinc-800 text-white flex items-center justify-center text-xl transition-all shadow-lg">üõ£Ô∏è</button>
                    <button onclick="app.toggleTheme()" class="w-10 h-10 rounded-full bg-zinc-800 flex items-center justify-center text-xl">üåô</button>
                </div>
            </div>
            
            <div id="route-panel" class="hidden mt-3 glass rounded-2xl p-4 space-y-3 animate-slideUp">
                <input id="destination-input" type="text" placeholder="¬øA d√≥nde vas?" class="w-full bg-black/20 border border-white/10 p-3 rounded-xl text-sm outline-none focus:border-neonPurple">
                <div class="flex gap-2">
                    <button onclick="app.calculateRoute()" class="flex-1 bg-neonPurple text-white py-2 rounded-xl text-xs font-bold">CALCULAR RUTA</button>
                    <button onclick="app.clearRoute()" class="px-4 bg-red-600/20 text-red-500 py-2 rounded-xl text-xs font-bold">X</button>
                </div>
                <p id="route-info" class="text-[10px] opacity-60 text-center italic">Tambi√©n puedes tocar el mapa para marcar el destino.</p>
            </div>
        </header>

        <div id="map"></div>

        <div id="selection-banner" class="fixed top-24 left-1/2 -translate-x-1/2 z-[2000] hidden">
            <div class="bg-neonPurple text-white px-6 py-2 rounded-full text-[10px] font-bold shadow-2xl animate-pulse">
                üìç MODO SELECCI√ìN ACTIVO
            </div>
        </div>

        <div class="fixed right-4 top-1/2 -translate-y-1/2 ui-element flex flex-col gap-3">
            <button onclick="app.startPinSelection('POLICE')" class="glass w-12 h-12 rounded-xl flex items-center justify-center text-2xl shadow-lg">üëÆ</button>
            <button onclick="app.startPinSelection('ACCIDENT')" class="glass w-12 h-12 rounded-xl flex items-center justify-center text-2xl shadow-lg">üö®</button>
            <button onclick="app.startPinSelection('TRAFFIC')" class="glass w-12 h-12 rounded-xl flex items-center justify-center text-2xl shadow-lg">üöß</button>
        </div>

        <footer class="fixed bottom-6 left-0 w-full ui-element px-6">
            <div class="max-w-md mx-auto flex justify-between items-center">
                <button onclick="app.toggleModal('store-modal')" class="glass p-4 rounded-2xl text-xl">üõí</button>
                <button onclick="app.centerMap()" class="w-16 h-16 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-full flex items-center justify-center shadow-2xl border-4 border-black text-xl">üìç</button>
                <button onclick="app.toggleModal('profile-modal')" class="glass p-4 rounded-2xl text-xl">üë§</button>
            </div>
        </footer>
    </div>

    <div id="notif-container" class="fixed top-32 left-4 right-4 z-[6000] pointer-events-none flex flex-col gap-2"></div>

    <script>
        const app = {
            map: null, userMarker: null, userName: localStorage.getItem('nexoUserName') || '',
            nexoPoints: parseInt(localStorage.getItem('nexoPoints')) || 0,
            routingControl: null, routeMode: false, pendingPinType: null,

            init() { if (this.userName) this.showMainUI(); },

            registerUser() {
                const name = document.getElementById('userName').value.trim();
                if (name.length < 2) return;
                this.userName = name;
                localStorage.setItem('nexoUserName', name);
                this.showMainUI();
            },

            showMainUI() {
                document.getElementById('userNameDisplay').textContent = this.userName;
                document.getElementById('userAvatar').src = `https://api.dicebear.com/7.x/bottts-neutral/svg?seed=${this.userName}`;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-ui').classList.remove('hidden');
                setTimeout(() => { document.getElementById('main-ui').style.opacity = '1'; this.initMap(); }, 50);
            },

            initMap() {
                this.map = L.map('map', { zoomControl: false, attributionControl: false }).setView([-12.043, -77.028], 14);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(this.map);
                this.getUserLocation();
                
                // Si el modo ruta est√° activo, permitir click para destino
                this.map.on('click', (e) => {
                    if (this.routeMode) this.setRouteDestination(e.latlng);
                    else if (this.pendingPinType) this.handleReportClick(e.latlng);
                });
            },

            getUserLocation() {
                navigator.geolocation.getCurrentPosition((pos) => {
                    const ll = [pos.coords.latitude, pos.coords.longitude];
                    if (this.userMarker) this.map.removeLayer(this.userMarker);
                    this.userMarker = L.circleMarker(ll, { radius: 8, color: '#9D00FF', fillColor: '#00D1FF', fillOpacity: 1 }).addTo(this.map);
                    this.map.setView(ll, 15);
                });
            },

            // --- L√ìGICA DE RUTAS ---
            toggleRouteMode() {
                this.routeMode = !this.routeMode;
                const panel = document.getElementById('route-panel');
                const btn = document.getElementById('route-btn');
                panel.classList.toggle('hidden');
                btn.classList.toggle('bg-neonPurple');
                this.showNotify("MODO RUTA", this.routeMode ? "Toca el mapa para marcar tu destino" : "Buscador desactivado");
            },

            setRouteDestination(latlng) {
                if (!this.userMarker) return this.showNotify("ERROR", "No detecto tu ubicaci√≥n");
                this.calculateRoute(latlng);
            },

            calculateRoute(destLatLng = null) {
                if (this.routingControl) this.map.removeControl(this.routingControl);

                const origin = this.userMarker.getLatLng();
                const destination = destLatLng || document.getElementById('destination-input').value;

                if (!destination) return;

                this.routingControl = L.Routing.control({
                    waypoints: [ L.latLng(origin.lat, origin.lng), destination ],
                    routeWhileDragging: true,
                    lineOptions: {
                        styles: [
                            { color: '#9D00FF', opacity: 0.8, weight: 8 }, // Color por defecto (Morado)
                        ]
                    },
                    // Personalizaci√≥n de colores seg√∫n distancia
                    altLineOptions: {
                        styles: [
                            { color: '#FF3131', opacity: 0.6, weight: 6 }, // Ruta alternativa (Rojo)
                        ]
                    },
                    createMarker: function(i, wp) {
                        return L.marker(wp.latLng, { draggable: true, icon: L.divIcon({ html: i === 0 ? 'üè†' : 'üèÅ', className: 'text-2xl' }) });
                    }
                }).addTo(this.map);

                this.routingControl.on('routesfound', (e) => {
                    const routes = e.routes;
                    this.showNotify("RUTA LISTA", `Distancia: ${(routes[0].summary.totalDistance / 1000).toFixed(1)} km`);
                });
            },

            clearRoute() {
                if (this.routingControl) this.map.removeControl(this.routingControl);
                document.getElementById('destination-input').value = "";
                this.showNotify("RUTAS", "Mapa limpio");
            },

            // --- REPORTE Y OTROS ---
            startPinSelection(type) {
                this.pendingPinType = type;
                document.getElementById('selection-banner').classList.remove('hidden');
            },

            handleReportClick(latlng) {
                const icons = { 'POLICE': 'üëÆ', 'ACCIDENT': 'üö®', 'TRAFFIC': 'üöß' };
                L.marker(latlng, { icon: L.divIcon({ html: `<div class="text-3xl animate-bounce">${icons[this.pendingPinType]}</div>`, className: 'pin' }) }).addTo(this.map);
                this.showNotify("REPORTE", "¬°Gracias! +5 NP");
                this.pendingPinType = null;
                document.getElementById('selection-banner').classList.add('hidden');
            },

            centerMap() { if (this.userMarker) this.map.setView(this.userMarker.getLatLng(), 16); },

            showNotify(title, text) {
                const container = document.getElementById('notif-container');
                const n = document.createElement('div');
                n.className = 'glass p-3 rounded-xl border-l-4 border-neonPurple animate-slideUp pointer-events-auto';
                n.innerHTML = `<div class="text-[10px] font-bold text-neonPurple">${title}</div><div class="text-xs">${text}</div>`;
                container.appendChild(n);
                setTimeout(() => n.remove(), 4000);
            },

            toggleTheme() { /* L√≥gica de tema */ },
            toggleModal(id) { /* L√≥gica de modales */ }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>
