<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="NEXO - Red de inteligencia colaborativa para riders">
    <title>NEXO | Rider Intelligence Network</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { 
                extend: { 
                    colors: { neonPurple: '#9D00FF', neonBlue: '#00D1FF' },
                    animation: { 'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite' }
                } 
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Syncopate:wght@700&family=Rajdhani:wght@400;600;700&display=swap');
        
        body { font-family: 'Rajdhani', sans-serif; overscroll-behavior: none; }
        .font-syncopate { font-family: 'Syncopate', sans-serif; }
        
        #map { height: 100vh; width: 100vw; z-index: 1; background: #050505; }
        
        .glass { 
            background: rgba(255, 255, 255, 0.8); 
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .dark .glass { 
            background: rgba(10, 10, 10, 0.8); 
            border: 1px solid rgba(157, 0, 255, 0.2);
        }

        /* Estilo para el marcador del usuario */
        .user-location-marker {
            background: #00D1FF;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 0 15px #00D1FF;
        }

        .custom-pin { filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); }
    </style>
</head>
<body class="bg-slate-50 dark:bg-black text-slate-900 dark:text-gray-100 overflow-hidden">

    <div id="login-screen" class="fixed inset-0 z-[9999] bg-black flex flex-col justify-center items-center p-6 transition-transform duration-700">
        <div class="text-center mb-12 animate-pulse-slow">
            <h1 class="text-6xl font-bold font-syncopate mb-2 text-transparent bg-clip-text bg-gradient-to-r from-neonBlue to-neonPurple">NEXO</h1>
            <p class="text-[10px] tracking-[0.4em] text-white/50 uppercase">Rider Intelligence System</p>
        </div>
        <div class="w-full max-w-xs space-y-4">
            <input id="userName" type="text" placeholder="ID OPERADOR" class="w-full bg-zinc-900 border border-zinc-800 p-4 rounded-2xl text-white text-center font-mono focus:border-neonPurple outline-none transition-all">
            <button onclick="app.registerUser()" class="w-full bg-neonPurple py-4 rounded-2xl font-bold text-white shadow-[0_0_20px_rgba(157,0,0,0.4)] active:scale-95 transition-transform">INICIAR SESI√ìN</button>
        </div>
    </div>

    <div id="main-ui" class="invisible opacity-0 transition-all duration-1000">
        <header class="fixed top-6 left-4 right-4 z-[1000]">
            <div class="glass rounded-2xl p-3 flex justify-between items-center shadow-2xl">
                <div class="flex items-center gap-3">
                    <img id="userAvatar" class="w-10 h-10 rounded-full border border-neonPurple">
                    <div>
                        <h2 id="userNameDisplay" class="font-bold text-xs uppercase tracking-tighter">---</h2>
                        <span id="pointsDisplay" class="text-neonBlue font-mono text-[10px] font-bold">0 NP</span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="app.toggleTheme()" class="w-9 h-9 flex items-center justify-center rounded-xl bg-zinc-100 dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800">
                        <span id="theme-icon">üåô</span>
                    </button>
                </div>
            </div>
        </header>

        <div id="map"></div>

        <div id="selection-banner" class="fixed top-24 left-1/2 -translate-x-1/2 z-[1000] hidden pointer-events-none">
            <div class="bg-neonPurple text-white px-6 py-2 rounded-full text-[10px] font-bold shadow-2xl animate-bounce">
                üìç TOCA EL MAPA PARA REPORTAR
            </div>
        </div>

        <div class="fixed right-4 top-1/2 -translate-y-1/2 z-[1000] flex flex-col gap-4">
            <button onclick="app.startPinSelection('POLICE')" class="glass w-14 h-14 rounded-2xl flex items-center justify-center text-2xl shadow-xl active:scale-90 transition-transform">üëÆ</button>
            <button onclick="app.startPinSelection('ACCIDENT')" class="glass w-14 h-14 rounded-2xl flex items-center justify-center text-2xl shadow-xl active:scale-90 transition-transform">üö®</button>
            <button onclick="app.startPinSelection('TRAFFIC')" class="glass w-14 h-14 rounded-2xl flex items-center justify-center text-2xl shadow-xl active:scale-90 transition-transform">üöß</button>
        </div>

        <footer class="fixed bottom-8 left-0 w-full z-[1000] px-6">
            <div class="max-w-md mx-auto flex justify-between items-center">
                <button onclick="app.toggleModal('store-modal')" class="glass w-14 h-14 rounded-2xl flex items-center justify-center text-xl">üõí</button>
                
                <button onclick="app.centerMap()" class="w-16 h-16 bg-white dark:bg-neonPurple rounded-full flex items-center justify-center shadow-[0_0_30px_rgba(157,0,255,0.4)] border-4 border-zinc-900">
                    <span class="text-2xl dark:text-white text-black">üéØ</span>
                </button>

                <button onclick="app.toggleModal('profile-modal')" class="glass w-14 h-14 rounded-2xl flex items-center justify-center text-xl">üë§</button>
            </div>
        </footer>
    </div>

    <div id="notif-container" class="fixed top-28 left-4 right-4 z-[5000] pointer-events-none flex flex-col gap-2"></div>

    <div id="store-modal" class="fixed inset-0 z-[6000] hidden bg-black/80 backdrop-blur-md flex items-end">
        <div class="w-full glass rounded-t-[3rem] p-10 transform transition-transform">
            <div class="w-12 h-1.5 bg-zinc-500/30 mx-auto mb-6 rounded-full"></div>
            <h2 class="text-2xl font-bold mb-6 italic">NEXO MARKET</h2>
            <div class="bg-zinc-100 dark:bg-zinc-900/50 p-4 rounded-3xl border border-zinc-200 dark:border-zinc-800 flex justify-between items-center">
                <div>
                    <p class="font-bold">Upgrade Rango</p>
                    <p class="text-xs opacity-50">Sube tu prioridad de reporte</p>
                </div>
                <button onclick="app.buyWithPoints('Upgrade', 1000)" class="bg-neonBlue text-black px-4 py-2 rounded-xl font-bold text-xs">1000 NP</button>
            </div>
            <button onclick="app.toggleModal('store-modal')" class="w-full mt-8 py-4 text-sm opacity-50 font-bold uppercase tracking-widest">Cerrar</button>
        </div>
    </div>

    <div id="profile-modal" class="fixed inset-0 z-[6000] hidden bg-black/80 backdrop-blur-md flex items-end">
        <div class="w-full glass rounded-t-[3rem] p-10">
            <div class="text-center">
                <div class="relative inline-block">
                    <img id="profileAvatar" class="w-20 h-20 rounded-full border-2 border-neonPurple mx-auto">
                    <div class="absolute -bottom-1 -right-1 bg-green-500 w-5 h-5 rounded-full border-4 border-black"></div>
                </div>
                <h3 id="profileName" class="text-xl font-bold mt-4 tracking-tighter uppercase">...</h3>
                <div class="grid grid-cols-2 gap-4 mt-8">
                    <div class="bg-zinc-900/50 p-4 rounded-2xl border border-zinc-800">
                        <span class="block text-[10px] opacity-50 uppercase">Puntos</span>
                        <span id="profilePoints" class="text-xl font-bold text-neonBlue">0</span>
                    </div>
                    <div class="bg-zinc-900/50 p-4 rounded-2xl border border-zinc-800">
                        <span class="block text-[10px] opacity-50 uppercase">Reportes</span>
                        <span id="totalReports" class="text-xl font-bold text-neonPurple">0</span>
                    </div>
                </div>
                <button onclick="app.logout()" class="w-full bg-red-500/10 text-red-500 py-4 rounded-2xl font-bold mt-8 text-xs border border-red-500/20">CERRAR SESI√ìN</button>
                <button onclick="app.toggleModal('profile-modal')" class="w-full mt-4 py-2 text-xs opacity-40 font-bold uppercase">Volver</button>
            </div>
        </div>
    </div>

    <script>
        const app = {
            map: null,
            userMarker: null,
            watchId: null,
            theme: localStorage.getItem('nexoTheme') || 'dark',
            nexoPoints: parseInt(localStorage.getItem('nexoPoints')) || 0,
            totalReports: parseInt(localStorage.getItem('totalReports')) || 0,
            userName: localStorage.getItem('nexoUserName') || '',
            reports: JSON.parse(localStorage.getItem('nexoReports')) || [],
            pendingPinType: null,
            tileLayer: null,

            init() {
                document.documentElement.className = this.theme;
                if (this.userName) {
                    this.showMainUI();
                }
            },

            registerUser() {
                const input = document.getElementById('userName');
                const name = input.value.trim();
                if (name.length < 3) return this.showNotify("ERROR", "ID demasiado corto");
                this.userName = name;
                localStorage.setItem('nexoUserName', name);
                this.showMainUI();
            },

            showMainUI() {
                document.getElementById('userNameDisplay').textContent = this.userName;
                document.getElementById('profileName').textContent = this.userName;
                
                const avatar = `https://api.dicebear.com/7.x/bottts-neutral/svg?seed=${this.userName}`;
                document.getElementById('userAvatar').src = avatar;
                document.getElementById('profileAvatar').src = avatar;

                document.getElementById('login-screen').classList.add('-translate-y-full');
                const main = document.getElementById('main-ui');
                main.classList.remove('invisible');
                setTimeout(() => {
                    main.classList.add('opacity-100');
                    this.initMap();
                    this.updatePointsUI();
                }, 300);
            },

            initMap() {
                if (this.map) return;
                
                this.map = L.map('map', { 
                    zoomControl: false, 
                    attributionControl: false,
                    maxZoom: 18
                }).setView([-12.043, -77.028], 14);

                this.updateMapTheme();
                this.loadSavedReports();
                
                this.map.on('click', (e) => this.handleMapClick(e));
                this.startTracking();
            },

            updateMapTheme() {
                const style = this.theme === 'dark' ? 'dark_all' : 'rastertiles/voyager';
                if (this.tileLayer) this.map.removeLayer(this.tileLayer);
                this.tileLayer = L.tileLayer(`https://{s}.basemaps.cartocdn.com/${style}/{z}/{x}/{y}{r}.png`).addTo(this.map);
            },

            startTracking() {
                if ("geolocation" in navigator) {
                    this.watchId = navigator.geolocation.watchPosition(
                        (pos) => {
                            const latlng = [pos.coords.latitude, pos.coords.longitude];
                            if (!this.userMarker) {
                                this.userMarker = L.circleMarker(latlng, {
                                    radius: 10,
                                    className: 'user-location-marker'
                                }).addTo(this.map);
                                this.map.setView(latlng, 16);
                            } else {
                                this.userMarker.setLatLng(latlng);
                            }
                        },
                        (err) => this.showNotify("GPS", "Activa el GPS para usar NEXO"),
                        { enableHighAccuracy: true }
                    );
                }
            },

            startPinSelection(type) {
                this.pendingPinType = type;
                document.getElementById('selection-banner').classList.remove('hidden');
                this.showNotify("MODO REPORTE", "Toca el lugar exacto en el mapa");
            },

            handleMapClick(e) {
                if (!this.pendingPinType) return;

                const icons = { 'POLICE': 'üëÆ', 'ACCIDENT': 'üö®', 'TRAFFIC': 'üöß' };
                const newReport = {
                    lat: e.latlng.lat,
                    lng: e.latlng.lng,
                    type: this.pendingPinType,
                    id: Date.now()
                };

                this.addMarkerToMap(newReport);
                this.reports.push(newReport);
                localStorage.setItem('nexoReports', JSON.stringify(this.reports));

                this.nexoPoints += 10;
                this.totalReports += 1;
                this.saveStats();
                this.updatePointsUI();
                
                this.showNotify("REPORTE ENVIADO", "+10 NP ganados");
                this.pendingPinType = null;
                document.getElementById('selection-banner').classList.add('hidden');
            },

            addMarkerToMap(report) {
                const icons = { 'POLICE': 'üëÆ', 'ACCIDENT': 'üö®', 'TRAFFIC': 'üöß' };
                const icon = L.divIcon({
                    html: `<div class="text-3xl animate-bounce custom-pin">${icons[report.type]}</div>`,
                    className: 'custom-pin-container',
                    iconSize: [30, 30]
                });
                L.marker([report.lat, report.lng], { icon }).addTo(this.map)
                 .bindPopup(`<div class="text-black font-bold">Reportado por: ${this.userName}</div>`);
            },

            loadSavedReports() {
                this.reports.forEach(r => this.addMarkerToMap(r));
            },

            updatePointsUI() {
                document.getElementById('pointsDisplay').textContent = `${this.nexoPoints} NP`;
                document.getElementById('profilePoints').textContent = this.nexoPoints;
                document.getElementById('totalReports').textContent = this.totalReports;
            },

            saveStats() {
                localStorage.setItem('nexoPoints', this.nexoPoints);
                localStorage.setItem('totalReports', this.totalReports);
            },

            toggleModal(id) {
                const modal = document.getElementById(id);
                modal.classList.toggle('hidden');
            },

            toggleTheme() {
                this.theme = this.theme === 'dark' ? 'light' : 'dark';
                document.documentElement.className = this.theme;
                document.getElementById('theme-icon').textContent = this.theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
                localStorage.setItem('nexoTheme', this.theme);
                this.updateMapTheme();
            },

            showNotify(title, text) {
                const container = document.getElementById('notif-container');
                const n = document.createElement('div');
                n.className = 'glass p-4 rounded-2xl border-l-4 border-neonPurple shadow-2xl transition-all duration-500 transform translate-x-full';
                n.innerHTML = `<div class="text-[10px] font-black text-neonPurple uppercase">${title}</div><div class="text-xs font-semibold">${text}</div>`;
                container.appendChild(n);
                
                setTimeout(() => n.classList.remove('translate-x-full'), 100);
                setTimeout(() => {
                    n.classList.add('opacity-0', '-translate-y-4');
                    setTimeout(() => n.remove(), 500);
                }, 4000);
            },

            centerMap() {
                if (this.userMarker) {
                    this.map.flyTo(this.userMarker.getLatLng(), 17);
                }
            },

            logout() {
                if(confirm("¬øCerrar sesi√≥n? Se perder√°n los reportes locales.")) {
                    localStorage.clear();
                    location.reload();
                }
            }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>
