<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEXO | Rider Intelligence Network</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        neonPurple: '#9D00FF',
                        neonBlue: '#00D1FF',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Syncopate:wght@400;700&family=Rajdhani:wght@300;500;700&family=JetBrains+Mono:wght@400;700&display=swap');
        
        :root {
            --neon-purple: #9D00FF;
            --deep-black: #050505;
        }

        body { 
            font-family: 'Rajdhani', sans-serif;
            overflow: hidden;
            touch-action: manipulation;
            transition: background-color 0.3s, color 0.3s;
        }

        #map { height: 100vh; width: 100vw; position: absolute; top: 0; left: 0; z-index: 0; }

        /* Clases de Cristalograf√≠a (Glassmorphism) mejoradas */
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        .dark .glass {
            background: rgba(15, 15, 15, 0.8);
            border: 1px solid rgba(157, 0, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .neo-button:active { transform: scale(0.92); transition: 0.1s; }

        /* Efectos Visuales */
        .scanline {
            width: 100%; height: 100vh;
            background: repeating-linear-gradient(0deg, rgba(0,0,0,0) 0px, rgba(0,0,0,0) 2px, rgba(157, 0, 255, 0.02) 3px);
            position: fixed; top: 0; left: 0; pointer-events: none; z-index: 9999;
        }

        .other-rider-marker {
            width: 14px; height: 14px;
            background: var(--neon-purple);
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 0 12px var(--neon-purple);
        }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-active { animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-[#050505] text-slate-900 dark:text-gray-100">

    <div class="scanline dark:block hidden"></div>

    <div id="login-screen" class="fixed inset-0 z-[5000] bg-white dark:bg-black flex flex-col justify-center items-center p-6 text-center transition-colors">
        <div class="mb-10">
            <h1 class="text-6xl font-bold font-[Syncopate] tracking-tighter dark:text-white text-black" style="text-shadow: 0 0 20px rgba(157,0,255,0.4);">NEXO</h1>
            <p class="text-purple-600 dark:text-purple-400 font-mono text-[10px] tracking-[0.5em] mt-2 italic uppercase">Estableciendo Enlace Seguro</p>
        </div>
        <div class="w-full max-w-xs space-y-4">
            <input id="userName" type="text" placeholder="ID DEL OPERADOR" class="w-full bg-slate-100 dark:bg-zinc-900 border border-slate-200 dark:border-zinc-800 p-4 rounded-2xl outline-none focus:ring-2 ring-purple-500 transition-all font-mono text-center">
            <button onclick="registerUser()" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 py-4 rounded-2xl font-black text-white tracking-widest shadow-lg neo-button">
                AUTENTICAR
            </button>
        </div>
    </div>

    <div id="main-ui" class="hidden opacity-0 transition-opacity duration-700">
        
        <header class="fixed top-4 left-4 right-4 z-[1000]">
            <div class="glass rounded-2xl p-3 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="relative">
                        <img id="userAvatar" class="w-10 h-10 rounded-full border-2 border-purple-500">
                        <span class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white dark:border-zinc-900 rounded-full"></span>
                    </div>
                    <div>
                        <h2 id="userNameDisplay" class="font-bold text-sm uppercase leading-none mb-1">...</h2>
                        <span id="pointsDisplay" class="text-indigo-600 dark:text-neonBlue font-mono text-xs font-bold">0 NP</span>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="toggleTheme()" class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-200 dark:bg-zinc-800 text-lg">
                        <span id="theme-icon">üåô</span>
                    </button>
                    <div class="text-right border-l pl-4 border-slate-300 dark:border-zinc-700">
                        <div id="clock" class="text-sm font-bold font-mono">00:00</div>
                        <div class="text-[8px] opacity-60 tracking-widest uppercase">Red Nexo</div>
                    </div>
                </div>
            </div>
        </header>

        <div id="map"></div>

        <div class="fixed right-4 top-1/2 -translate-y-1/2 z-[900] flex flex-col gap-4">
            <button onclick="startPinSelection('POLICE')" class="glass w-14 h-14 rounded-2xl flex items-center justify-center text-2xl neo-button" title="Polic√≠a">üëÆ</button>
            <button onclick="startPinSelection('ACCIDENT')" class="glass w-14 h-14 rounded-2xl flex items-center justify-center text-2xl neo-button" title="Accidente">üö®</button>
            <button onclick="startPinSelection('TRAFFIC')" class="glass w-14 h-14 rounded-2xl flex items-center justify-center text-2xl neo-button" title="Tr√°fico">üöß</button>
        </div>

        <div id="selection-banner" class="fixed top-24 left-1/2 -translate-x-1/2 z-[2000] hidden">
            <div class="bg-indigo-600 text-white px-6 py-2 rounded-full text-xs font-bold shadow-2xl animate-pulse">
                TOCA EL PUNTO EN EL MAPA
            </div>
        </div>

        <footer class="fixed bottom-6 left-0 w-full z-[1000] px-6">
            <div class="max-w-md mx-auto flex justify-between items-center">
                <button onclick="toggleModal('store-modal')" class="glass p-4 rounded-2xl text-slate-600 dark:text-zinc-400 neo-button">
                    <span class="text-xl">üõí</span>
                </button>

                <button onclick="centerMap()" class="w-20 h-20 bg-gradient-to-tr from-purple-600 to-indigo-700 rounded-full flex items-center justify-center shadow-[0_10px_30px_rgba(79,70,229,0.5)] border-4 border-white dark:border-zinc-900 neo-button">
                    <span class="font-black text-white italic text-lg">GPS</span>
                </button>

                <button onclick="toggleModal('profile-modal')" class="glass p-4 rounded-2xl text-slate-600 dark:text-zinc-400 neo-button">
                    <span class="text-xl">üë§</span>
                </button>
            </div>
        </footer>
    </div>

    <div id="store-modal" class="fixed inset-0 z-[4000] hidden bg-black/40 dark:bg-black/80 backdrop-blur-sm">
        <div class="absolute bottom-0 w-full glass rounded-t-[2.5rem] p-8 modal-active">
            <div class="w-12 h-1.5 bg-slate-300 dark:bg-zinc-700 mx-auto mb-6 rounded-full"></div>
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-black">NEXO STORE</h2>
                <button onclick="toggleModal('store-modal')" class="text-3xl">&times;</button>
            </div>
            
            <div class="space-y-4 max-h-[50vh] overflow-y-auto pr-2">
                <div class="bg-white dark:bg-zinc-900/50 border border-slate-200 dark:border-zinc-800 p-4 rounded-3xl flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 bg-purple-100 dark:bg-purple-900/30 rounded-2xl flex items-center justify-center text-2xl">üéí</div>
                        <div>
                            <h3 class="font-bold text-sm">Mochila Pro</h3>
                            <p class="text-[10px] opacity-60">Edici√≥n Limitada</p>
                        </div>
                    </div>
                    <button onclick="buyItem('Mochila Nexo', 500)" class="bg-indigo-600 px-5 py-2 rounded-xl text-xs font-bold text-white neo-button">500 NP</button>
                </div>
            </div>
        </div>
    </div>

    <div id="profile-modal" class="fixed inset-0 z-[4000] hidden bg-black/40 dark:bg-black/80 backdrop-blur-sm">
        <div class="absolute bottom-0 w-full glass rounded-t-[2.5rem] p-8 modal-active">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black">MI EQUIPO</h2>
                <button onclick="toggleModal('profile-modal')" class="text-3xl">&times;</button>
            </div>
            <div id="inventory-list" class="grid grid-cols-2 gap-4 pb-10">
                </div>
        </div>
    </div>

    <div id="notif-container" class="fixed top-24 left-4 right-4 z-[5000] pointer-events-none flex flex-col gap-2"></div>

    <script>
        let map, userMarker, theme = 'dark';
        let nexoPoints = parseInt(localStorage.getItem('nexoPoints')) || 0;
        let inventory = JSON.parse(localStorage.getItem('nexoInventory')) || [];
        let pendingPinType = null;

        // --- SISTEMA DE TEMA ---
        function toggleTheme() {
            theme = theme === 'dark' ? 'light' : 'dark';
            document.documentElement.classList.toggle('dark');
            document.getElementById('theme-icon').innerText = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
            
            // Cambiar estilo del mapa
            const provider = theme === 'dark' ? 'dark_all' : 'rastertiles/voyager';
            L.tileLayer(`https://{s}.basemaps.cartocdn.com/${provider}/{z}/{x}/{y}{r}.png`).addTo(map);
        }

        function registerUser() {
            const name = document.getElementById('userName').value.trim();
            if (name.length < 2) return showNotify("ERROR", "ID no v√°lido");

            localStorage.setItem('nexoUser', name);
            document.getElementById('userNameDisplay').innerText = name;
            document.getElementById('userAvatar').src = `https://api.dicebear.com/7.x/bottts-neutral/svg?seed=${name}`;
            
            document.getElementById('login-screen').classList.add('opacity-0');
            setTimeout(() => {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-ui').classList.remove('hidden');
                setTimeout(() => document.getElementById('main-ui').style.opacity = '1', 50);
                initNexoSystem();
            }, 500);
        }

        function initNexoSystem() {
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([-12.043, -77.028], 14);
            
            // Tile inicial
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(pos => {
                    const latlng = [pos.coords.latitude, pos.coords.longitude];
                    if (!userMarker) {
                        userMarker = L.circleMarker(latlng, { radius: 10, color: '#9D00FF', fillColor: '#00D1FF', fillOpacity: 1, weight: 3 }).addTo(map);
                        map.flyTo(latlng, 16);
                    } else {
                        userMarker.setLatLng(latlng);
                    }
                });
            }

            spawnOtherRiders();
            updatePointsUI();
            startClock();
            showNotify("SISTEMA", "Red inteligente activada");

            map.on('click', (e) => {
                if (pendingPinType) submitReport(e.latlng);
            });
        }

        function updatePointsUI() {
            document.getElementById('pointsDisplay').innerText = `${nexoPoints} NP`;
            localStorage.setItem('nexoPoints', nexoPoints);
        }

        function startPinSelection(type) {
            pendingPinType = type;
            document.getElementById('selection-banner').classList.remove('hidden');
        }

        function submitReport(latlng) {
            const icons = { 'POLICE': 'üëÆ', 'ACCIDENT': 'üö®', 'TRAFFIC': 'üöß' };
            const icon = L.divIcon({ html: `<div class="text-4xl filter drop-shadow-lg animate-bounce">${icons[pendingPinType]}</div>`, className: 'bg-transparent' });
            L.marker(latlng, { icon }).addTo(map);
            
            nexoPoints += 50;
            updatePointsUI();
            showNotify("LOGRO", "+50 NP por reporte vial");
            pendingPinType = null;
            document.getElementById('selection-banner').classList.add('hidden');
        }

        function spawnOtherRiders() {
            for(let i=0; i<5; i++) {
                const lat = -12.043 + (Math.random() - 0.5) * 0.04;
                const lng = -77.028 + (Math.random() - 0.5) * 0.04;
                const markerIcon = L.divIcon({ className: 'other-rider-marker' });
                L.marker([lat, lng], { icon: markerIcon }).addTo(map);
            }
        }

        function toggleModal(id) {
            const m = document.getElementById(id);
            m.classList.toggle('hidden');
            if (id === 'profile-modal') updateInventoryUI();
        }

        function showNotify(title, msg) {
            const container = document.getElementById('notif-container');
            const toast = document.createElement('div');
            toast.className = 'glass p-4 rounded-2xl border-l-4 border-indigo-500 flex flex-col shadow-xl transition-all duration-500 transform translate-y-0';
            toast.innerHTML = `<span class="text-[9px] font-black text-indigo-500 uppercase">${title}</span><span class="text-xs font-bold">${msg}</span>`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('opacity-0', '-translate-y-4');
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        function startClock() {
            const update = () => {
                document.getElementById('clock').innerText = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            };
            update();
            setInterval(update, 1000);
        }

        function centerMap() {
            if (userMarker) map.flyTo(userMarker.getLatLng(), 16);
        }

        function updateInventoryUI() {
            const container = document.getElementById('inventory-list');
            if (inventory.length === 0) {
                container.innerHTML = '<p class="col-span-2 text-center py-10 opacity-50 text-sm italic">Sin objetos en el inventario</p>';
                return;
            }
            container.innerHTML = inventory.map(item => `
                <div class="bg-white dark:bg-zinc-800/50 p-4 rounded-3xl border border-slate-200 dark:border-zinc-700 text-center">
                    <div class="text-3xl mb-1">${item.icon}</div>
                    <div class="text-[10px] font-bold uppercase">${item.name}</div>
                </div>
            `).join('');
        }

        function buyItem(name, cost) {
            if (nexoPoints < cost) return showNotify("FALLIDO", "Necesitas m√°s puntos");
            nexoPoints -= cost;
            inventory.push({ name, icon: 'üéí' });
            localStorage.setItem('nexoInventory', JSON.stringify(inventory));
            updatePointsUI();
            showNotify("COMPRA", "Objeto a√±adido a tu equipo");
            toggleModal('store-modal');
        }
    </script>
</body>
</html>
