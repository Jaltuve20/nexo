<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEXO | Rider Intelligence Network</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { neonPurple: '#9D00FF', neonBlue: '#00D1FF' } } }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Syncopate:wght@400;700&family=Rajdhani:wght@300;500;700&family=JetBrains+Mono:wght@400;700&display=swap');
        :root { --neon-purple: #9D00FF; --deep-black: #050505; }
        body { font-family: 'Rajdhani', sans-serif; overflow: hidden; touch-action: manipulation; }
        #map { height: 100vh; width: 100vw; position: absolute; top: 0; left: 0; z-index: 1; }
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(0, 0, 0, 0.1); }
        .dark .glass { background: rgba(15, 15, 15, 0.8); border: 1px solid rgba(157, 0, 255, 0.2); }
        .neo-button:active { transform: scale(0.92); }
        .ui-element { z-index: 1000; position: relative; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-active { animation: slideUp 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-[#050505] text-slate-900 dark:text-gray-100">

    <div id="login-screen" class="fixed inset-0 z-[5000] bg-white dark:bg-black flex flex-col justify-center items-center p-6 text-center">
        <h1 class="text-6xl font-bold font-[Syncopate] mb-10 dark:text-white">NEXO</h1>
        <div class="w-full max-w-xs space-y-4">
            <input id="userName" type="text" placeholder="ID OPERADOR" class="w-full bg-slate-100 dark:bg-zinc-900 border p-4 rounded-2xl outline-none text-center font-mono">
            <button onclick="registerUser()" class="w-full bg-indigo-600 py-4 rounded-2xl font-black text-white tracking-widest neo-button">ENTRAR</button>
        </div>
    </div>

    <div id="main-ui" class="hidden opacity-0 transition-opacity duration-700">
        <header class="fixed top-4 left-4 right-4 ui-element">
            <div class="glass rounded-2xl p-3 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <img id="userAvatar" class="w-10 h-10 rounded-full border-2 border-purple-500">
                    <div>
                        <h2 id="userNameDisplay" class="font-bold text-sm uppercase leading-none">...</h2>
                        <span id="pointsDisplay" class="text-indigo-600 dark:text-neonBlue font-mono text-xs font-bold">0 NP</span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="toggleModal('info-modal')" class="w-8 h-8 rounded-full bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 font-bold">?</button>
                    <button onclick="toggleTheme()" class="w-8 h-8 rounded-full bg-slate-200 dark:bg-zinc-800"><span id="theme-icon">ðŸŒ™</span></button>
                </div>
            </div>
        </header>

        <div id="map"></div>

        <div id="selection-banner" class="fixed top-24 left-1/2 -translate-x-1/2 z-[2000] hidden">
            <div class="bg-indigo-600 text-white px-6 py-2 rounded-full text-xs font-bold animate-pulse shadow-xl">
                TOCA EL MAPA PARA COLOCAR EL PIN
            </div>
        </div>

        <div class="fixed right-4 top-1/2 -translate-y-1/2 ui-element flex flex-col gap-4">
            <button onclick="startPinSelection('POLICE')" class="glass w-14 h-14 rounded-2xl flex items-center justify-center text-2xl neo-button shadow-lg">ðŸ‘®</button>
            <button onclick="startPinSelection('ACCIDENT')" class="glass w-14 h-14 rounded-2xl flex items-center justify-center text-2xl neo-button shadow-lg">ðŸš¨</button>
            <button onclick="startPinSelection('TRAFFIC')" class="glass w-14 h-14 rounded-2xl flex items-center justify-center text-2xl neo-button shadow-lg">ðŸš§</button>
        </div>

        <footer class="fixed bottom-6 left-0 w-full ui-element px-6">
            <div class="max-w-md mx-auto flex justify-between items-center">
                <button onclick="toggleModal('store-modal')" class="glass p-4 rounded-2xl neo-button">ðŸ›’</button>
                <button onclick="centerMap()" class="w-20 h-20 bg-indigo-600 rounded-full flex items-center justify-center shadow-2xl border-4 border-white dark:border-zinc-900 neo-button text-white font-bold">GPS</button>
                <button onclick="toggleModal('profile-modal')" class="glass p-4 rounded-2xl neo-button">ðŸ‘¤</button>
            </div>
        </footer>
    </div>

    <div id="info-modal" class="fixed inset-0 z-[4000] hidden bg-black/50 backdrop-blur-sm">
        <div class="absolute bottom-0 w-full glass rounded-t-[2.5rem] p-8 modal-active">
            <h2 class="text-xl font-black mb-4 uppercase">InformaciÃ³n Nexo</h2>
            <p class="text-sm mb-4">Gana **5 NP** por cada reporte de trÃ¡fico, policÃ­a o accidente. CanjÃ©alos en la tienda por equipamiento.</p>
            <button onclick="toggleModal('info-modal')" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">CERRAR</button>
        </div>
    </div>

    <div id="store-modal" class="fixed inset-0 z-[4000] hidden bg-black/50 backdrop-blur-sm">
        <div class="absolute bottom-0 w-full glass rounded-t-[2.5rem] p-8 modal-active">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-black italic">NEXO STORE</h2>
                <button onclick="toggleModal('store-modal')" class="text-2xl">&times;</button>
            </div>
            <div class="bg-white dark:bg-zinc-900 p-4 rounded-2xl flex justify-between items-center border border-zinc-200 dark:border-zinc-800">
                <div class="flex items-center gap-3">
                    <span class="text-3xl">ðŸŽ’</span>
                    <div>
                        <p class="font-bold text-sm">Mochila Rider</p>
                        <p class="text-[10px] opacity-50">500 NP o S/ 200</p>
                    </div>
                </div>
                <button onclick="buyItem('Mochila', 500)" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-xs font-bold uppercase">Canjear</button>
            </div>
        </div>
    </div>

    <div id="notif-container" class="fixed top-24 left-4 right-4 z-[5000] pointer-events-none flex flex-col gap-2"></div>

    <script>
        let map, userMarker, theme = 'dark';
        let nexoPoints = parseInt(localStorage.getItem('nexoPoints')) || 0;
        let pendingPinType = null;

        function registerUser() {
            const name = document.getElementById('userName').value.trim();
            if (name.length < 2) return;
            document.getElementById('userNameDisplay').innerText = name;
            document.getElementById('userAvatar').src = `https://api.dicebear.com/7.x/bottts-neutral/svg?seed=${name}`;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-ui').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('main-ui').style.opacity = '1';
                initMap();
            }, 50);
        }

        function initMap() {
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([-12.043, -77.028], 14);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
            
            // Forzar que el mapa detecte bien el tamaÃ±o
            setTimeout(() => { map.invalidateSize(); }, 200);

            map.on('click', function(e) {
                if (pendingPinType) {
                    const icons = { 'POLICE': 'ðŸ‘®', 'ACCIDENT': 'ðŸš¨', 'TRAFFIC': 'ðŸš§' };
                    const myIcon = L.divIcon({ 
                        html: `<div style="font-size:30px; filter:drop-shadow(0 2px 4px rgba(0,0,0,0.5))" class="animate-bounce">${icons[pendingPinType]}</div>`, 
                        className: 'dummy' 
                    });
                    L.marker(e.latlng, { icon: myIcon }).addTo(map);
                    
                    nexoPoints += 5;
                    updatePointsUI();
                    showNotify("Ã‰XITO", "Reporte enviado. +5 NP");
                    
                    pendingPinType = null;
                    document.getElementById('selection-banner').classList.add('hidden');
                }
            });

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(p => {
                    const ll = [p.coords.latitude, p.coords.longitude];
                    userMarker = L.circleMarker(ll, { radius: 8, color: '#9D00FF', fillColor: '#00D1FF', fillOpacity: 1 }).addTo(map);
                    map.setView(ll, 15);
                });
            }
        }

        function startPinSelection(type) {
            pendingPinType = type;
            document.getElementById('selection-banner').classList.remove('hidden');
            showNotify("MODO PIN", "Toca el mapa donde estÃ¡ el evento");
        }

        function updatePointsUI() {
            document.getElementById('pointsDisplay').innerText = `${nexoPoints} NP`;
            localStorage.setItem('nexoPoints', nexoPoints);
        }

        function showNotify(title, msg) {
            const container = document.getElementById('notif-container');
            const toast = document.createElement('div');
            toast.className = 'glass p-3 rounded-xl border-l-4 border-indigo-500 shadow-2xl';
            toast.innerHTML = `<p class="text-[9px] font-bold text-indigo-500 uppercase">${title}</p><p class="text-xs font-bold">${msg}</p>`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 500); }, 3000);
        }

        function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); }

        function toggleTheme() {
            theme = theme === 'dark' ? 'light' : 'dark';
            document.documentElement.classList.toggle('dark');
            document.getElementById('theme-icon').innerText = theme === 'dark' ? 'ðŸŒ™' : 'â˜€ï¸';
            const style = theme === 'dark' ? 'dark_all' : 'rastertiles/voyager';
            L.tileLayer(`https://{s}.basemaps.cartocdn.com/${style}/{z}/{x}/{y}{r}.png`).addTo(map);
        }

        function centerMap() { if(userMarker) map.flyTo(userMarker.getLatLng(), 15); }

        function buyItem(name, cost) {
            if (nexoPoints >= cost) {
                nexoPoints -= cost;
                updatePointsUI();
                showNotify("COMPRA", "Â¡Objeto canjeado!");
                toggleModal('store-modal');
            } else {
                showNotify("ERROR", "Puntos insuficientes");
            }
        }
    </script>
</body>
</html>
